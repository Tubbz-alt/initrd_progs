#!/bin/sh
#
# * $applet_list is generated by busybox_static.petbuild
#   after compiling a busybox compatible with the os arch
# * This script can be called from anywhere and will
#   always work in the directory it is located in
# * First try to use actual applet list, otherwise fall back to $applet_list
#
# Arguments:
# $1 = busybox binary to use
#

applet_list='[ [[ acpid addgroup adduser arch arp arping ash base64 basename bbconfig beep blkdiscard blkid blockdev brctl bunzip2 bzcat bzip2 cal cat chgrp chmod chown chpasswd chroot chvt cksum clear cp cpio crond crontab cryptpw cut date dc dd deallocvt delgroup deluser depmod devmem df dhcprelay diff dirname dmesg dnsd dnsdomainname dos2unix dpkg dpkg-deb du dumpkmap dumpleases echo eject elspci env ether-wake expand expr factor fakeidentd fallocate false fatattr fbset fbsplash fdflush fdformat fdisk fgconsole find findfs flash_eraseall flash_lock flash_unlock flashcp flock fold free freeramdisk fsfreeze fsync ftpd ftpget ftpput fuser getopt getty groups guess_fstype gunzip gzip halt hd hdparm head hexdump hexedit hostid hostname httpd hwclock i2cdetect i2cdump i2cget i2cset id ifconfig ifdown ifenslave ifplugd ifup inetd init inotifyd insmod ionice iostat ip ipaddr ipcalc iplink ipneigh iproute iprule iptunnel kbd_mode kill killall klogd less link linux32 linux64 linuxrc ln loadfont loadkmap logger login logname logread losetup ls lsmod lsof lspci lsscsi lsusb lzcat lzma lzop lzopcat makedevs man md5sum mdev mesg microcom mkdir mkfifo mknod mkpasswd mkswap mktemp modinfo modprobe more mount mountpoint mpstat mv nameif nanddump nandwrite nbd-client nc netcat netstat nice nl nmeter nohup nproc nsenter nslookup ntpd od openvt partprobe passwd paste patch pgrep pidof ping ping6 pipe_progress pivot_root pkill pmap poweroff powertop printenv printf ps pscan pstree pwd pwdx raidautorun rdate rdev readahead readlink realpath reboot renice reset resize rev rfkill rm rmdir rmmod route rpm rpm2cpio rtcwake run-parts rx sed seq setarch setconsole setfattr setfont setkeycodes setlogcons setpriv setserial setsid sh sha1sum sha256sum sha3sum sha512sum showkey shred slattach sleep sort split ssl_client start-stop-daemon stat strings stty su sulogin sum swapoff swapon switch_root sync sysctl syslogd tac tail tar taskset tcpsvd tee telnet telnetd test tftp tftpd time timeout top touch tr traceroute traceroute6 true truncate tty ttysize tunctl ubiattach ubidetach ubimkvol ubirename ubirmvol ubirsvol ubiupdatevol udhcpc udhcpc6 udhcpd udpsvd uevent umount uname uncompress unexpand uniq unix2dos unlink unlzma unlzop unshare unxz unzip uptime usleep uudecode uuencode vconfig vercmp vlock volname watch watchdog wc wget which whoami whois xargs xxd xz xzcat yes zcat zcip '

sdir=$(dirname "$0")

if [ -x "$1" ] ; then
	# busybox path has been specified, not in initrd
	# ex: [chroot $NEWROOT] [$PATH_TO/]bb-create-symlinks /bin/busybox
	echo "Creating symlinks to $1 in $sdir"
	alist=$($1 --list)
	[ "x$alist" = "x" ] && alist="$applet_list"
	for a in $alist ; do
		[ ! -e "$a" ] && ln -s $1 "$sdir/$a"
	done
	exit 0
fi

#------------------------------------------------------
#                      initrd
#------------------------------------------------------

if [ -f "$sdir/busybox" ] ; then
	alist=$($sdir/busybox --list)
	[ "x$alist" = "x" ] && alist="$applet_list"
	for a in $alist ; do
		[ ! -e "$a" ] && ln -s busybox "$sdir/$a"
	done
fi

if [ -f "$sdir/exfatfsck" ] ; then
	ln -s exfatfsck "$sdir/fsck.exfat"
fi

if [ -f "$sdir/mount.exfat-fuse" ] ; then
	ln -s mount.exfat-fuse "$sdir/mount.exfat"
fi

if [ -f "$sdir/ntfs-3g" ] ; then
	ln -s ntfs-3g "$sdir/mount.ntfs"
fi

if [ -f "$sdir/fsck.fat" ] ; then
	ln -s fsck.fat "$sdir/fsck.vfat"
	ln -s fsck.fat "$sdir/fsck.msdos"
fi

if [ -f "$sdir/e2fsck" ] ; then
	ln -s e2fsck "$sdir/fsck.ext2"
	ln -s e2fsck "$sdir/fsck.ext3"
	ln -s e2fsck "$sdir/fsck.ext4"
	ln -s e2fsck "$sdir/fsck.ext4dev"
fi

if [ -f "$sdir/nano" ] ; then
	ln -sf nano "$sdir/pico"
	ln -sf nano "$sdir/mp"
	ln -sf nano "$sdir/ed"
fi

if [ -f "$sdir/kmod" ] ; then
	rm -f $sdir/{depmod,insmod,lsmod,modinfo,modprobe,rmmod} 2>/dev/null
	ln -sf kmod $sdir/depmod
	ln -sf kmod $sdir/insmod
	ln -sf kmod $sdir/lsmod
	ln -sf kmod $sdir/modinfo
	ln -sf kmod $sdir/modprobe
	ln -sf kmod $sdir/rmmod
fi

### END ###
